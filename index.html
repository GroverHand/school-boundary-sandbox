<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>School Boundary Sandbox - Filters & Enhanced Summary</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
  <style>
    html, body { height:100%; margin:0; font-family: Arial, sans-serif; }
    #map { position:absolute; top:50px; bottom:0; left:0; right:300px; }
    #topbar { position:absolute; top:0; left:0; right:300px; height:50px;
      background:#f8f8f8; border-bottom:1px solid #ddd; padding:5px; display:flex; align-items:center; gap:10px; }
    #sidebar { position:absolute; top:0; right:0; width:300px; height:100%; background:#fff;
      border-left:1px solid #ddd; padding:10px; overflow:auto; }
    .btn { padding:4px 8px; background:#1976d2; color:#fff; border:none; border-radius:3px; cursor:pointer; }
    .btn:disabled { background:#aaa; }
    label { font-size:12px; }
    select { font-size:12px; }
    table { width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
    th, td { border:1px solid #aaa; padding:4px 6px; text-align:left; }
    .color-box { display:inline-block; width:12px; height:12px; vertical-align:middle; margin-right:4px; }
  </style>
</head>
<body>
  <div id="topbar">
    <input type="file" id="csvFile" accept=".csv"/>
    <label>Filter Grade:
      <select id="filterGrade"><option value="">All</option></select>
    </label>
    <label>Filter School (NAME):
      <select id="filterSchool"><option value="">All</option></select>
    </label>
    <label>Filter Lunch:
      <select id="filterLunch"><option value="">All</option></select>
    </label>
    <button class="btn" id="downloadSelected" disabled>Download Selected CSV</button>
  </div>
  <div id="map"></div>
  <div id="sidebar">
    <div id="summaryContainer">
      <div id="summaryHeader"></div>
      <div id="summaryTable"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
  <script>
    // Globals
    let allRows = [], markers = [], selected = [], lunchCol;
    const map = L.map('map').setView([46.8772,-96.7898],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'Â© OSM contrib' }).addTo(map);
    const shapes = L.featureGroup().addTo(map);
    const drawControl = new L.Control.Draw({ draw:{polygon:true,rectangle:true}, edit:{featureGroup:shapes} });
    map.addControl(drawControl);

    // UI refs
    const filterGrade = document.getElementById('filterGrade');
    const filterSchool = document.getElementById('filterSchool');
    const filterLunch = document.getElementById('filterLunch');
    const csvInput = document.getElementById('csvFile');
    const downloadBtn = document.getElementById('downloadSelected');
    const summaryHeader = document.getElementById('summaryHeader');
    const summaryTable = document.getElementById('summaryTable');

    // Handlers
    csvInput.addEventListener('change', handleCSV);
    shapes.on('draw:created draw:edited draw:deleted', updateSelection);
    filterGrade.addEventListener('change', updateSelection);
    filterSchool.addEventListener('change', updateSelection);
    filterLunch.addEventListener('change', updateSelection);
    downloadBtn.addEventListener('click', downloadCSV);

    async function handleCSV(){
      clearAll();
      const file = csvInput.files[0];
      const res = await new Promise(r=>Papa.parse(file,{header:true,skipEmptyLines:true,complete:r}));
      allRows = res.data;
      if(!allRows.length) return alert('Empty CSV');
      // detect lunch column
      lunchCol = Object.keys(allRows[0]).find(c=>/lunch/i.test(c))||null;
      populateFilters(allRows);
      addMarkers(allRows);
      map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
      downloadBtn.disabled = false;
      updateSelection();
    }

    function populateFilters(rows){
      const uniq = (k) => [...new Set(rows.map(r=>r[k]).filter(x=>x!=null))].sort();
      // grade
      uniq('grade').forEach(v=>filterGrade.append(new Option(v,v)));
      // school Name column
      uniq('NAME').forEach(v=>filterSchool.append(new Option(v,v)));
      // lunch
      if(lunchCol) uniq(lunchCol).forEach(v=>filterLunch.append(new Option(v,v)));
      else filterLunch.parentElement.style.display='none';
    }

    function addMarkers(rows){
      rows.forEach(r=>{
        const lat = parseFloat(r.lat||r.latitude||r.Y);
        const lon = parseFloat(r.lon||r.lng||r.X);
        if(isFinite(lat)&&isFinite(lon)){
          const m = L.circleMarker([lat,lon],{radius:4});
          m.feature = r;
          m.addTo(map);
          markers.push(m);
        }
      });
    }

    function passesFilters(r){
      return (!filterGrade.value||r.grade===filterGrade.value)
          &&(!filterSchool.value||r.NAME===filterSchool.value)
          &&(!filterLunch.value||(lunchCol&&r[lunchCol]===filterLunch.value));
    }

    function updateSelection(){
      // determine selected within shapes
      const layersArr = shapes.getLayers();
      if(!layersArr.length){
        summaryHeader.innerHTML = ''; summaryTable.innerHTML = '';
        return;
      }
      const union = layersArr.reduce((u, l) => u ? turf.union(u, l.toGeoJSON()) : l.toGeoJSON(), null);
      selected = markers.filter(m=>{
        const p = turf.point([m.getLatLng().lng,m.getLatLng().lat]);
        return turf.booleanPointInPolygon(p, union) && passesFilters(m.feature);
      }).map(m=>m.feature);
      renderSummary();
    }

    function renderSummary(){
      const total = markers.length;
      const notContained = total - selected.length;
      // Header
      summaryHeader.innerHTML = `<strong style="color:#c00">${total.toLocaleString()}</strong> Students Plotted&nbsp;
        <small>(${notContained.toLocaleString()} Not Contained)</small>`;
      // Table by grade
      const freq = {};
      selected.forEach(r=>{const g=r.grade||'N/A'; freq[g]=(freq[g]||0)+1;});
      let html = `<table><thead><tr><th>Item</th><th># Contained</th><th>% Contained</th></tr></thead><tbody>`;
      const grades = Object.keys(freq).sort();
      grades.forEach(g=>{
        const cnt = freq[g], pct = (cnt/selected.length*100).toFixed(2)+'%';
        html += `<tr><td><div class="color-box" style="background:#888"></div>${g}</td>
                <td>${cnt.toLocaleString()}</td><td>${pct}</td></tr>`;
      });
      html += `<tr style="font-weight:bold;">
        <td>Total / % of All</td>
        <td>${selected.length.toLocaleString()}</td>
        <td>${(selected.length/total*100).toFixed(2)+'%'}</td>
      </tr>`;
      html += `</tbody></table>`;
      summaryTable.innerHTML = html;
    }

    function downloadCSV(){
      if(!selected.length) return;
      const csv = Papa.unparse(selected);
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'selection.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    function clearAll(){
      markers.forEach(m=>map.removeLayer(m));
      markers=[]; shapes.clearLayers(); selected=[]; downloadBtn.disabled=true;
      // clear filters
      filterGrade.selectedIndex=0; filterSchool.selectedIndex=0; filterLunch.selectedIndex=0;
      document.getElementById('summaryHeader').innerHTML=''; document.getElementById('summaryTable').innerHTML='';
    }
  </script>
</body>
</html>
