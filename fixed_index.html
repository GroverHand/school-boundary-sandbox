<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>School Boundary Sandbox - Fixed</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <style>
    html, body { height:100%; margin:0; font-family:Arial,sans-serif; }
    #map { height:88vh; }
    #topbar { position:absolute; top:10px; left:10px; z-index:1000; background:white; padding:6px; box-shadow:0 0 6px rgba(0,0,0,0.2);}
    #progress { margin-top:4px; font-size:12px; display:none; }
    .sidebar { position:absolute; top:10px; right:10px; z-index:1000; width:360px; max-height:88vh; overflow:auto;
               background:rgba(255,255,255,0.95); padding:10px; box-shadow:0 0 6px rgba(0,0,0,0.2); }
    table { width:100%; border-collapse:collapse; font-size:12px; }
    th, td { border:1px solid #aaa; padding:4px; text-align:left; }
    .btn { background:#1976d2; color:white; padding:4px 8px; border:none; border-radius:3px; cursor:pointer; }
    .btn:disabled { background:#aaa; }
    .section-title { font-weight:bold; margin:8px 0 4px; }
  </style>
</head>
<body>
  <div id="topbar">
    <input type="file" id="csvFile" accept=".csv"/>
    <button id="downloadSelected" class="btn" disabled>Download CSV</button>
    <div id="progress"></div>
  </div>
  <div id="map"></div>
  <div class="sidebar" id="info" style="display:none;">
    <div class="section-title" id="counts"></div>
    <div id="summary"></div>
    <div id="tableContainer"></div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.3/papaparse.min.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
    // Config
    const DELAY = 1100, CENTER = [46.8772,-96.7898];
    const DEFAULT_CATEGORICAL = ['grade','school','PROGRAM','ELL','IEP'];
    let markers=[], rows=[], selected=[], shapes=L.featureGroup();
    // Map init
    const map=L.map('map').setView(CENTER,11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OSM'}).addTo(map);
    shapes.addTo(map);
    const drawCtrl=new L.Control.Draw({
     <!-- Load libraries from cdnjs -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
  />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>

    map.on(L.Draw.Event.CREATED,e=>{shapes.addLayer(e.layer);update();});
    map.on(L.Draw.Event.EDITED,update);
    map.on(L.Draw.Event.DELETED,update);
    // CSV load
    document.getElementById('csvFile').addEventListener('change',e=>{
      const f=e.target.files[0];
      if(!f) return;
      Papa.parse(f,{header:true,skipEmptyLines:true,complete:async res=>{
        clearAll();
        rows=res.data;
        if(!rows.length){alert('Empty CSV');return;}
        const cols=Object.keys(rows[0]);
        const latKey=cols.find(c=>/^(lat|latitude|y)$/i.test(c));
        const lonKey=cols.find(c=>/^(lon|lng|longitude|x)$/i.test(c));
        if(latKey&&lonKey){
          addFromLatLon(rows,latKey,lonKey);
          map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
        } else {
          const up=cols.map(c=>c.toUpperCase());
          if(!['ADDRESS','CITY','STATE','ZIP'].every(c=>up.includes(c))){
            alert('Need LAT/LON or ADDRESS,CITY,STATE,ZIP');
            return;
          }
          await geocode(rows,cols[up.indexOf('ADDRESS')],cols[up.indexOf('CITY')],
                        cols[up.indexOf('STATE')],cols[up.indexOf('ZIP')]);
          map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
        }
        alert(markers.length+' points loaded');
      }});
    });
    function clearAll(){
      markers.forEach(m=>map.removeLayer(m));markers=[];rows=[];selected=[];shapes.clearLayers();
      document.getElementById('info').style.display='none';document.getElementById('downloadSelected').disabled=true;
    }
    function addFromLatLon(rs,yk,xk){
      rs.forEach(r=>{const lat=parseFloat(r[yk]),lon=parseFloat(r[xk]);
        if(isFinite(lat)&&isFinite(lon)&&lat&&lon){
          const m=L.circleMarker([lat,lon],{radius:4}).addTo(map);
          m.feature=r;markers.push(m);
        }
      });
    }
    async function geocode(rs,ak,ck,sk,zk){
      const p=document.getElementById('progress');
      p.style.display='block';
      for(let i=0;i<rs.length;i++){
        p.textContent=`Geocoding ${i+1}/${rs.length}`;
        const r=rs[i];
        const q=[r[ak],r[ck],r[sk],r[zk]].filter(Boolean).join(', ');
        try{
          const j=await fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q))
            .then(x=>x.json());
          if(j.length){
            const lat=parseFloat(j[0].lat),lon=parseFloat(j[0].lon);
            const m=L.circleMarker([lat,lon],{radius:4}).addTo(map);
            m.feature=r;markers.push(m);
          }
        }catch{}
        await new Promise(r=>setTimeout(r,DELAY));
      }
      p.style.display='none';
    }
    function update(){
      selected=[];shapes.getLayers().forEach(shape=>{
        const poly=shape.toGeoJSON();
        markers.forEach(m=>{
          if(turf.booleanPointInPolygon(turf.point([m.getLatLng().lng,m.getLatLng().lat]),poly)){
            selected.push(m.feature);
          }
        });
      });
      render();
    }
    function render(){
      if(!selected.length){document.getElementById('info').style.display='none';return;}
      document.getElementById('info').style.display='block';
      document.getElementById('downloadSelected').disabled=false;
      document.getElementById('counts').innerText='Total: '+selected.length;
      // summary
      const cols=Object.keys(selected[0]);
      let cats=DEFAULT_CATEGORICAL.filter(c=>cols.includes(c));
      if(!cats.length){
        cats=cols.filter(c=>{
          const vs=selected.map(r=>r[c]).filter(v=>v!=null);
          return vs.length&&new Set(vs).size<=15&&vs.some(v=>isNaN(v));
        });
      }
      let sumHTML='<div class="section-title">Summary</div>';
      cats.forEach(c=>{
        const freq={};
        selected.forEach(r=>freq[r[c]]=(freq[r[c]]||0)+1);
        sumHTML+='<div><strong>'+c+'</strong><ul>';
        Object.entries(freq).forEach(([k,v])=>sumHTML+=`<li>${k}: ${v}</li>`);
        sumHTML+='</ul></div>';
      });
      document.getElementById('summary').innerHTML=sumHTML;
      // table
      let tbl='<table><thead><tr>';
      Object.keys(selected[0]).forEach(h=>tbl+=`<th>${h}</th>`);
      tbl+='</tr></thead><tbody>';
      selected.forEach(r=>{tbl+='<tr>';Object.keys(r).forEach(h=>tbl+=`<td>${r[h]||''}</td>`);tbl+='</tr>';});
      tbl+='</tbody></table>';
      document.getElementById('tableContainer').innerHTML=tbl;
    }
    document.getElementById('downloadSelected').onclick=()=>{
      const csv=Papa.unparse(selected);
      const b=new Blob([csv],{type:'text/csv'});
      const u=URL.createObjectURL(b);
      const a=document.createElement('a');
      a.href=u;a.download='selected.csv';a.click();
      URL.revokeObjectURL(u);
    };
  </script>
</body>
</html>
